<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Prompt design</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Prompt design</h1>



<p>This vignette gives you some advice about how to use ellmer to write
prompts. We’ll work through two hopefully relevant examples: a prompt
that generates code and another that extracts structured data. If you’ve
never written a prompt, I’d highly recommend reading Ethan Mollick’s <a href="https://www.oneusefulthing.org/p/getting-started-with-ai-good-enough">Getting
started with AI: Good enough prompting</a>. I think understanding his
analogy about how AI works will really help you get started:</p>
<blockquote>
<p>Treat AI like an infinitely patient new coworker who forgets
everything you tell them each new conversation, one that comes highly
recommended but whose actual abilities are not that clear. … Two parts
of this are analogous to working with humans (being new on the job and
being a coworker) and two of them are very alien (forgetting everything
and being infinitely patient). We should start with where AIs are
closest to humans, because that is the key to good-enough prompting</p>
</blockquote>
<p>As well as learning general prompt design skills, it’s also a good
idea to read any specific advice for the model that you’re using. Here
are some pointers to the prompt design guides of some of the most
popular models:</p>
<ul>
<li><a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview">Claude</a></li>
<li><a href="https://platform.openai.com/docs/guides/prompt-engineering">OpenAI</a></li>
<li><a href="https://ai.google.dev/gemini-api/docs/prompting-intro">Gemini</a></li>
</ul>
<p>If you have a claude account, you can use its <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/prompt-generator">prompt-generator</a>.
It’s specifically tailored for Claude, but I suspect it will help you
with many other LLMs, or at least give you some ideas as to what else to
include in your prompt.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span></code></pre></div>
<div id="best-practices" class="section level2">
<h2>Best practices</h2>
<p>It’s highly likely that you’ll end up writing long, possibly
multi-page prompts. To ensure your success with this task, we have two
recommendations. First, put each prompt its own, separate file. Second,
write the prompts using markdown. The reason to use markdown is that
it’s quite readable to LLMs (and humans), and it allows you to do things
like use headers to divide up a prompt into sections and itemised lists
to enumerate multiple options. You can see some examples of this style
of prompt here:</p>
<ul>
<li><a href="https://github.com/posit-dev/shiny-assistant/blob/main/shinyapp/app_prompt_python.md" class="uri">https://github.com/posit-dev/shiny-assistant/blob/main/shinyapp/app_prompt_python.md</a></li>
<li><a href="https://github.com/jcheng5/py-sidebot/blob/main/prompt.md" class="uri">https://github.com/jcheng5/py-sidebot/blob/main/prompt.md</a></li>
<li><a href="https://github.com/simonpcouch/pal/tree/main/inst/prompts" class="uri">https://github.com/simonpcouch/pal/tree/main/inst/prompts</a></li>
<li><a href="https://github.com/cpsievert/aidea/blob/main/inst/app/prompt.md" class="uri">https://github.com/cpsievert/aidea/blob/main/inst/app/prompt.md</a></li>
</ul>
<p>In terms of file names, if you only have one prompt in your project,
call it <code>prompt.md</code>. If you have multiple prompts, give them
informative names like <code>prompt-extract-metadata.md</code> or
<code>prompt-summarize-text.md</code>. If you’re writing a package, put
your prompt(s) in <code>inst/prompts</code>, otherwise it’s fine to put
them in the project’s root directory.</p>
<p>Your prompts are going to change over time, so we’d highly recommend
commiting them to a git repo. That will ensure that you can easily see
what has changed, and that if you accidentally make a mistake you can
easily roll back to a known good verison.</p>
<p>If your prompt includes dynamic data, use
<code>ellmer::interpolate_file()</code> to intergrate it into your
prompt. <code>interpolate_file()</code> works like <a href="https://glue.tidyverse.org">glue</a> but uses <code>{{ }}</code>
instead of <code>{ }</code> to make it easier to work with JSON.</p>
<p>As you iterate the prompt, it’s a good idea to build up a small set
of challenging examples that you can regularly re-check with your latest
version of the prompt. Currently you’ll need to do this by hand, but we
hope to eventually provide tools that’ll help you do this a little more
formally.</p>
<p>Unfortunately, you won’t see these best practices in action in this
vignette since we’re keeping the prompts short and inline to make it
easier for you to grok what’s going on.</p>
</div>
<div id="code-generation" class="section level2">
<h2>Code generation</h2>
<p>Let’s explore prompt design for a simple code generation task:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>question <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="st">  How can I compute the mean and median of variables a, b, c, and so on,</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="st">  all the way up to z, grouped by age and sex.</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="st">&quot;</span></span></code></pre></div>
<p>I’ll use <code>chat_claude()</code> for this problem because in our
experience it does the best job of generating code.</p>
<div id="basic-flavour" class="section level3">
<h3>Basic flavour</h3>
<p>When I don’t provide a system prompt, I sometimes get answers in
different languages or different styles of R code:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>()</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; Here&#39;s how to compute mean and median for variables a through z, grouped by age
#&gt; and sex:
#&gt; 
#&gt; ```r
#&gt; # Using dplyr
#&gt; library(dplyr)
#&gt; 
#&gt; df %&gt;%
#&gt;   group_by(age, sex) %&gt;%
#&gt;   summarise(across(a:z, list(
#&gt;     mean = ~mean(., na.rm = TRUE),
#&gt;     median = ~median(., na.rm = TRUE)
#&gt;   )))
#&gt; 
#&gt; # Alternative base R approach
#&gt; aggregate(. ~ age + sex, data = df[,c(&quot;age&quot;, &quot;sex&quot;, letters)], 
#&gt;          FUN = function(x) c(mean = mean(x), median = median(x)))
#&gt; ```
#&gt; 
#&gt; This will:
#&gt; 1. Group the data by age and sex
#&gt; 2. Calculate mean and median for each variable a through z
#&gt; 3. Handle missing values with na.rm = TRUE
#&gt; 4. Return results in a tidy format
#&gt; 
#&gt; The output will show means and medians for each age-sex combination.</code></pre>
<p>I can ensure that I always get R code in a specific style by
providing a system prompt:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>(<span class="at">system_prompt =</span> <span class="st">&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="st">  You are an expert R programmer who prefers the tidyverse.</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="st">&quot;</span>)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; Here&#39;s how you can compute means and medians for variables a through z, grouped
#&gt; by age and sex, using tidyverse functions:
#&gt; 
#&gt; ```r
#&gt; library(tidyverse)
#&gt; 
#&gt; df %&gt;%
#&gt;   group_by(age, sex) %&gt;%
#&gt;   summarise(across(
#&gt;     .cols = a:z,
#&gt;     .fns = list(
#&gt;       mean = ~mean(., na.rm = TRUE),
#&gt;       median = ~median(., na.rm = TRUE)
#&gt;     )
#&gt;   )) %&gt;%
#&gt;   ungroup()
#&gt; ```
#&gt; 
#&gt; This code will:
#&gt; 1. Group the data by age and sex
#&gt; 2. Use `across()` to apply both mean and median functions to all columns from 
#&gt; &#39;a&#39; to &#39;z&#39;
#&gt; 3. Handle missing values with `na.rm = TRUE`
#&gt; 4. The result will have columns named like `a_mean`, `a_median`, `b_mean`, 
#&gt; `b_median`, etc.
#&gt; 
#&gt; If you want to make the output more tidy (long format), you could add:
#&gt; 
#&gt; ```r
#&gt; df %&gt;%
#&gt;   group_by(age, sex) %&gt;%
#&gt;   summarise(across(
#&gt;     .cols = a:z,
#&gt;     .fns = list(
#&gt;       mean = ~mean(., na.rm = TRUE),
#&gt;       median = ~median(., na.rm = TRUE)
#&gt;     )
#&gt;   )) %&gt;%
#&gt;   ungroup() %&gt;%
#&gt;   pivot_longer(
#&gt;     cols = -c(age, sex),
#&gt;     names_to = c(&quot;variable&quot;, &quot;statistic&quot;),
#&gt;     names_pattern = &quot;(.*)_(.*)&quot;,
#&gt;     values_to = &quot;value&quot;
#&gt;   )
#&gt; ```
#&gt; 
#&gt; This will give you a long format with columns: age, sex, variable, statistic, 
#&gt; and value.</code></pre>
<p>Note that I’m using both a system prompt (which defines the general
behaviour) and a user prompt (which asks the specific question). You
could put all this content in the user prompt and get similar results,
but I think it’s helpful to use both to cleanly divide the general
framing of the response from the specific questions you ask.</p>
<p>Since I’m mostly interested in the code, I ask it to drop the
explanation and sample data:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>(<span class="at">system_prompt =</span> <span class="st">&quot;</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="st">  You are an expert R programmer who prefers the tidyverse.</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="st">  Just give me the code. I don&#39;t want any explanation or sample data.</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="st">&quot;</span>)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; ```r
#&gt; library(tidyverse)
#&gt; 
#&gt; df %&gt;%
#&gt;   group_by(age, sex) %&gt;%
#&gt;   summarise(across(a:z, list(
#&gt;     mean = ~mean(., na.rm = TRUE),
#&gt;     median = ~median(., na.rm = TRUE)
#&gt;   ))) %&gt;%
#&gt;   ungroup()
#&gt; ```</code></pre>
<p>And of course, if you want a different style of R code, just ask for
it:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>(<span class="at">system_prompt =</span> <span class="st">&quot;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="st">  You are an expert R programmer who prefers data.table.</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="st">  Just give me the code. I don&#39;t want any explanation or sample data.</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="st">&quot;</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; ```r
#&gt; library(data.table)
#&gt; DT[, lapply(.SD, function(x) list(mean = mean(x, na.rm = TRUE), 
#&gt;                                  median = median(x, na.rm = TRUE))), 
#&gt;    by = .(age, sex),
#&gt;    .SDcols = letters[1:26]]
#&gt; ```</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>(<span class="at">system_prompt =</span> <span class="st">&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="st">  You are an expert R programmer who prefers base R.</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="st">  Just give me the code. I don&#39;t want any explanation or sample data.</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="st">&quot;</span>)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; ```r
#&gt; aggregate(cbind(a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u, 
#&gt; v, w, x, y, z) ~ age + sex, 
#&gt;          data = data,
#&gt;          FUN = function(x) c(mean = mean(x, na.rm = TRUE), 
#&gt;                            median = median(x, na.rm = TRUE)))
#&gt; ```</code></pre>
</div>
<div id="be-explicit" class="section level3">
<h3>Be explicit</h3>
<p>If there’s something about the output that you don’t like, try being
more explicit. For example, the code isn’t styled quite how I’d like it,
so I provide more details about what I do want:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>(<span class="at">system_prompt =</span> <span class="st">&quot;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="st">  You are an expert R programmer who prefers the tidyverse.</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="st">  Just give me the code. I don&#39;t want any explanation or sample data.</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="st">  Follow the tidyverse style guide:</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="st">  * Spread long function calls across multiple lines.</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="st">  * Where needed, always indent function calls with two spaces.</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="st">  * Only name arguments that are less commonly used.</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="st">  * Always use double quotes for strings.</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="st">  * Use the base pipe, `|&gt;`, not the magrittr pipe `%&gt;%`.</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="st">&quot;</span>)</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; ```r
#&gt; data |&gt;
#&gt;   group_by(age, sex) |&gt;
#&gt;   summarise(
#&gt;     across(
#&gt;       a:z,
#&gt;       list(
#&gt;         mean = mean,
#&gt;         median = median
#&gt;       ),
#&gt;       na.rm = TRUE
#&gt;     ),
#&gt;     .groups = &quot;drop&quot;
#&gt;   )
#&gt; ```</code></pre>
<p>This still doesn’t yield exactly the code that I’d write, but it’s
pretty close.</p>
<p>You could provide a different prompt if you were looking for more
explanation of the code:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>(<span class="at">system_prompt =</span> <span class="st">&quot;</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="st">  You are an expert R teacher.</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="st">  I am a new R user who wants to improve my programming skills.</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="st">  Help me understand the code you produce by explaining each function call with</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="st">  a brief comment. For more complicated calls, add documentation to each</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="st">  argument. Just give me the code. I don&#39;t want any explanation or sample data.</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="st">&quot;</span>)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; ```r
#&gt; # Create a vector of variable names from &#39;a&#39; to &#39;z&#39;
#&gt; vars &lt;- letters
#&gt; 
#&gt; # Group data by age and sex, then compute mean and median for each variable
#&gt; result &lt;- data %&gt;%
#&gt;   group_by(age, sex) %&gt;%
#&gt;   summarise(
#&gt;     # Use across() to apply functions to multiple columns
#&gt;     across(
#&gt;       all_of(vars),  # Select variables a through z
#&gt;       list(
#&gt;         mean = ~mean(., na.rm = TRUE),    # Calculate mean, removing NAs
#&gt;         median = ~median(., na.rm = TRUE)  # Calculate median, removing NAs
#&gt;       )
#&gt;     ),
#&gt;     .groups = &quot;drop&quot;  # Drop grouping structure from result
#&gt;   )
#&gt; ```</code></pre>
</div>
<div id="teach-it-about-new-features" class="section level3">
<h3>Teach it about new features</h3>
<p>You can imagine LLMs as being a sort of an average of the internet at
a given point in time. That means they will provide popular answers,
which will tend to reflect older coding styles (either because the new
features aren’t in their index, or the older features are so much more
popular). So if you want your code to use specific newer language
features, you might need to provide the examples yourself:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_claude</span>(<span class="at">system_prompt =</span> <span class="st">&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="st">  You are an expert R programmer.</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="st">  Just give me the code; no explanation in text.</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="st">  Use the `.by` argument rather than `group_by()`.</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="st">  dplyr 1.1.0 introduced per-operation grouping with the `.by` argument.</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="st">  e.g., instead of:</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="st">  transactions |&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="st">    group_by(company, year) |&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="st">    mutate(total = sum(revenue))</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="st">  write this:</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="st">  transactions |&gt;</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="st">    mutate(</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="st">      total = sum(revenue),</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="st">      .by = c(company, year)</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="st">    )</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="st">&quot;</span>)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(question)</span></code></pre></div>
<pre><code>#&gt; ```r
#&gt; data |&gt;
#&gt;   summarise(
#&gt;     across(a:z, list(mean = mean, median = median)),
#&gt;     .by = c(age, sex)
#&gt;   )
#&gt; ```</code></pre>
</div>
</div>
<div id="structured-data" class="section level2">
<h2>Structured data</h2>
<p>Providing a rich set of examples is a great way to encourage the
output to produce exactly what you want. This is known as
<strong>multi-shot prompting</strong>. Below we’ll work through a prompt
that I designed to extract structured data from recipes, but the same
ideas apply in many other situations.</p>
<div id="getting-started" class="section level3">
<h3>Getting started</h3>
<p>My overall goal is to turn a list of ingredients, like the following,
into a nicely structured JSON that I can then analyse in R (e.g. compute
the total weight, scale the recipe up or down, or convert the units from
volumes to weights).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>ingredients <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="st">  ¾ cup (150g) dark brown sugar</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="st">  2 large eggs</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="st">  ¾ cup (165g) sour cream</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="st">  ½ cup (113g) unsalted butter, melted</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="st">  1 teaspoon vanilla extract</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="st">  ¾ teaspoon kosher salt</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="st">  ⅓ cup (80ml) neutral oil</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="st">  1½ cups (190g) all-purpose flour</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="st">  150g plus 1½ teaspoons sugar</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="st">&quot;</span></span></code></pre></div>
<p>(This isn’t the ingredient list for a real recipe but it includes a
sampling of styles that I encountered in my project.)</p>
<p>If you don’t have strong feelings about what the data structure
should look like, you can start with a very loose prompt and see what
you get back. I find this a useful pattern for underspecified problems
where the heavy lifting lies with precisely defining the problem you
want to solve. Seeing the LLM’s attempt to create a data structure gives
me something to react to, rather than having to start from a blank
page.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>instruct_json <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="st">  You&#39;re an expert baker who also loves JSON. I am going to give you a list of</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="st">  ingredients and your job is to return nicely structured JSON. Just return the</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="st">  JSON and no other commentary.</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openai</span>(instruct_json)</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="co">#&gt; Using model = &quot;gpt-4o&quot;.</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(ingredients)</span></code></pre></div>
<pre><code>#&gt; ```json
#&gt; {
#&gt;   &quot;ingredients&quot;: [
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;¾ cup&quot;,
#&gt;       &quot;weight&quot;: &quot;150g&quot;,
#&gt;       &quot;item&quot;: &quot;dark brown sugar&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;2&quot;,
#&gt;       &quot;size&quot;: &quot;large&quot;,
#&gt;       &quot;item&quot;: &quot;eggs&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;¾ cup&quot;,
#&gt;       &quot;weight&quot;: &quot;165g&quot;,
#&gt;       &quot;item&quot;: &quot;sour cream&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;½ cup&quot;,
#&gt;       &quot;weight&quot;: &quot;113g&quot;,
#&gt;       &quot;item&quot;: &quot;unsalted butter&quot;,
#&gt;       &quot;state&quot;: &quot;melted&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;1 teaspoon&quot;,
#&gt;       &quot;item&quot;: &quot;vanilla extract&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;¾ teaspoon&quot;,
#&gt;       &quot;item&quot;: &quot;kosher salt&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;⅓ cup&quot;,
#&gt;       &quot;volume&quot;: &quot;80ml&quot;,
#&gt;       &quot;item&quot;: &quot;neutral oil&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;1½ cups&quot;,
#&gt;       &quot;weight&quot;: &quot;190g&quot;,
#&gt;       &quot;item&quot;: &quot;all-purpose flour&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;weight&quot;: &quot;150g&quot;,
#&gt;       &quot;item&quot;: &quot;sugar&quot;
#&gt;     },
#&gt;     {
#&gt;       &quot;amount&quot;: &quot;1½ teaspoons&quot;,
#&gt;       &quot;item&quot;: &quot;sugar&quot;
#&gt;     }
#&gt;   ]
#&gt; }
#&gt; ```</code></pre>
<p>(I don’t know if the additional colour, “You’re an expert baker who
also loves JSON”, does anything, but I like to think this helps the LLM
get into the right mindset of a very nerdy baker.)</p>
</div>
<div id="provide-examples" class="section level3">
<h3>Provide examples</h3>
<p>This isn’t a bad start, but I prefer to cook with weight and I only
want to see volumes if weight isn’t available so I provide a couple of
examples of what I’m looking for. I was pleasantly suprised that I can
provide the input and output examples in such a loose format.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>instruct_weight <span class="ot">&lt;-</span> r<span class="st">&quot;(</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="st">  Here are some examples of the sort of output I&#39;m looking for:</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="st">  ¾ cup (150g) dark brown sugar</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="st">  {&quot;</span>name<span class="st">&quot;: &quot;</span>dark brown sugar<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 150, &quot;</span>unit<span class="st">&quot;: &quot;</span>g<span class="st">&quot;}</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="st">  ⅓ cup (80ml) neutral oil</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="st">  {&quot;</span>name<span class="st">&quot;: &quot;</span>neutral oil<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 80, &quot;</span>unit<span class="st">&quot;: &quot;</span>ml<span class="st">&quot;}</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="st">  2 t ground cinnamon</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="st">  {&quot;</span>name<span class="st">&quot;: &quot;</span>ground cinnamon<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 2, &quot;</span>unit<span class="st">&quot;: &quot;</span>teaspoon<span class="st">&quot;}</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="st">)&quot;</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openai</span>(<span class="fu">c</span>(instruct_json, instruct_weight))</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="co">#&gt; Using model = &quot;gpt-4o&quot;.</span></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(ingredients)</span></code></pre></div>
<pre><code>#&gt; ```json
#&gt; [
#&gt;   {&quot;name&quot;: &quot;dark brown sugar&quot;, &quot;quantity&quot;: 150, &quot;unit&quot;: &quot;g&quot;},
#&gt;   {&quot;name&quot;: &quot;large eggs&quot;, &quot;quantity&quot;: 2, &quot;unit&quot;: &quot;pieces&quot;},
#&gt;   {&quot;name&quot;: &quot;sour cream&quot;, &quot;quantity&quot;: 165, &quot;unit&quot;: &quot;g&quot;},
#&gt;   {&quot;name&quot;: &quot;unsalted butter, melted&quot;, &quot;quantity&quot;: 113, &quot;unit&quot;: &quot;g&quot;},
#&gt;   {&quot;name&quot;: &quot;vanilla extract&quot;, &quot;quantity&quot;: 1, &quot;unit&quot;: &quot;teaspoon&quot;},
#&gt;   {&quot;name&quot;: &quot;kosher salt&quot;, &quot;quantity&quot;: 0.75, &quot;unit&quot;: &quot;teaspoon&quot;},
#&gt;   {&quot;name&quot;: &quot;neutral oil&quot;, &quot;quantity&quot;: 80, &quot;unit&quot;: &quot;ml&quot;},
#&gt;   {&quot;name&quot;: &quot;all-purpose flour&quot;, &quot;quantity&quot;: 190, &quot;unit&quot;: &quot;g&quot;},
#&gt;   {&quot;name&quot;: &quot;sugar&quot;, &quot;quantity&quot;: 150, &quot;unit&quot;: &quot;g&quot;},
#&gt;   {&quot;name&quot;: &quot;sugar&quot;, &quot;quantity&quot;: 1.5, &quot;unit&quot;: &quot;teaspoon&quot;}
#&gt; ]
#&gt; ```</code></pre>
<p>Just providing the examples seems to work remarkably well. But I
found it useful to also include a description of what the examples are
trying to accomplish. I’m not sure if this helps the LLM or not, but it
certainly makes it easier for me to understand the organisation of the
whole prompt and check that I’ve covered the key pieces I’m interested
in.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>instruct_weight <span class="ot">&lt;-</span> r<span class="st">&quot;(</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="st">  * If an ingredient has both weight and volume, extract only the weight:</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="st">  ¾ cup (150g) dark brown sugar</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="st">  [</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>dark brown sugar<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 150, &quot;</span>unit<span class="st">&quot;: &quot;</span>g<span class="st">&quot;}</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="st">  ]</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a><span class="st">* If an ingredient only lists a volume, extract that.</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="st">  2 t ground cinnamon</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="st">  ⅓ cup (80ml) neutral oil</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a><span class="st">  [</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>ground cinnamon<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 2, &quot;</span>unit<span class="st">&quot;: &quot;</span>teaspoon<span class="st">&quot;},</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>neutral oil<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 80, &quot;</span>unit<span class="st">&quot;: &quot;</span>ml<span class="st">&quot;}</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a><span class="st">  ]</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a><span class="st">)&quot;</span></span></code></pre></div>
<p>This structure also allows me to give the LLMs a hint about how I
want multiple ingredients to be stored, i.e. as an JSON array.</p>
<p>I then iterated on the prompt, looking at the results from different
recipes to get a sense of what the LLM was getting wrong. Much of this
felt like I waws iterating on my own understanding of the problem as I
didn’t start by knowing exactly how I wanted the data. For example, when
I started out I didn’t really think about all the various ways that
ingredients are specified. For later analysis, I always want quantities
to be number, even if they were originally fractions, or the if the
units aren’t precise (like a pinch). It made me realise that some
ingredients are unitless.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>instruct_unit <span class="ot">&lt;-</span> r<span class="st">&quot;(</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="st">* If the unit uses a fraction, convert it to a decimal.</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="st">  ⅓ cup sugar</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="st">  ½ teaspoon salt</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="st">  [</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>dark brown sugar<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 0.33, &quot;</span>unit<span class="st">&quot;: &quot;</span>cup<span class="st">&quot;},</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>salt<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 0.5, &quot;</span>unit<span class="st">&quot;: &quot;</span>teaspoon<span class="st">&quot;}</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="st">  ]</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="st">* Quantities are always numbers</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="st">  pinch of kosher salt</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a><span class="st">  [</span></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>kosher salt<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 1, &quot;</span>unit<span class="st">&quot;: &quot;</span>pinch<span class="st">&quot;}</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a><span class="st">  ]</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a><span class="st">* Some ingredients don&#39;t have a unit.</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a><span class="st">  2 eggs</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a><span class="st">  1 lime</span></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a><span class="st">  1 apple</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a><span class="st">  [</span></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>egg<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 2},</span></span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;: &quot;</span>lime<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 1},</span></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a><span class="st">    {&quot;</span>name<span class="st">&quot;, &quot;</span>apple<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 1}</span></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a><span class="st">  ]</span></span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a><span class="st">)&quot;</span></span></code></pre></div>
<p>You might want to take a look at the <a href="https://gist.github.com/hadley/7688b4dd1e5e97b800c6d7d79e437b48">full
prompt</a> to see what I ended up with.</p>
</div>
<div id="structured-data-1" class="section level3">
<h3>Structured data</h3>
<p>Now that I’ve iterated to get a data structure I like, it seems
useful to formalise it and tell the LLM exactly what I’m looking for
when dealing with structured data. This guarantees that the LLM will
only return JSON, that the JSON will have the fields that you expect,
and that ellmer will convert it into an R data structure.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>type_ingredient <span class="ot">&lt;-</span> <span class="fu">type_object</span>(</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">type_string</span>(<span class="st">&quot;Ingredient name&quot;</span>),</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  <span class="at">quantity =</span> <span class="fu">type_number</span>(),</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  <span class="at">unit =</span> <span class="fu">type_string</span>(<span class="st">&quot;Unit of measurement&quot;</span>)</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>)</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>type_ingredients <span class="ot">&lt;-</span> <span class="fu">type_array</span>(<span class="at">items =</span> type_ingredient)</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openai</span>(<span class="fu">c</span>(instruct_json, instruct_weight))</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a><span class="co">#&gt; Using model = &quot;gpt-4o&quot;.</span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>data <span class="ot">&lt;-</span> chat<span class="sc">$</span><span class="fu">extract_data</span>(ingredients, <span class="at">type =</span> <span class="fu">type_object</span>(<span class="at">ingredients =</span> type_ingredients))</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a><span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(data<span class="sc">$</span>ingredients, as.data.frame))</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a><span class="co">#&gt;                              X[[i]]</span></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="co">#&gt; name.1             dark brown sugar</span></span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a><span class="co">#&gt; name.2                   large eggs</span></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a><span class="co">#&gt; name.3                   sour cream</span></span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a><span class="co">#&gt; name.4      unsalted butter, melted</span></span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a><span class="co">#&gt; name.5              vanilla extract</span></span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a><span class="co">#&gt; name.6                  kosher salt</span></span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a><span class="co">#&gt; name.7                  neutral oil</span></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a><span class="co">#&gt; name.8            all-purpose flour</span></span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a><span class="co">#&gt; name.9                        sugar</span></span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a><span class="co">#&gt; name.10                       sugar</span></span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a><span class="co">#&gt; quantity.1                      150</span></span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a><span class="co">#&gt; quantity.2                        2</span></span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a><span class="co">#&gt; quantity.3                      165</span></span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a><span class="co">#&gt; quantity.4                      113</span></span>
<span id="cb26-28"><a href="#cb26-28" tabindex="-1"></a><span class="co">#&gt; quantity.5                        1</span></span>
<span id="cb26-29"><a href="#cb26-29" tabindex="-1"></a><span class="co">#&gt; quantity.6                     0.75</span></span>
<span id="cb26-30"><a href="#cb26-30" tabindex="-1"></a><span class="co">#&gt; quantity.7                       80</span></span>
<span id="cb26-31"><a href="#cb26-31" tabindex="-1"></a><span class="co">#&gt; quantity.8                      190</span></span>
<span id="cb26-32"><a href="#cb26-32" tabindex="-1"></a><span class="co">#&gt; quantity.9                      150</span></span>
<span id="cb26-33"><a href="#cb26-33" tabindex="-1"></a><span class="co">#&gt; quantity.10                     1.5</span></span>
<span id="cb26-34"><a href="#cb26-34" tabindex="-1"></a><span class="co">#&gt; unit.1                            g</span></span>
<span id="cb26-35"><a href="#cb26-35" tabindex="-1"></a><span class="co">#&gt; unit.2                        count</span></span>
<span id="cb26-36"><a href="#cb26-36" tabindex="-1"></a><span class="co">#&gt; unit.3                            g</span></span>
<span id="cb26-37"><a href="#cb26-37" tabindex="-1"></a><span class="co">#&gt; unit.4                            g</span></span>
<span id="cb26-38"><a href="#cb26-38" tabindex="-1"></a><span class="co">#&gt; unit.5                     teaspoon</span></span>
<span id="cb26-39"><a href="#cb26-39" tabindex="-1"></a><span class="co">#&gt; unit.6                     teaspoon</span></span>
<span id="cb26-40"><a href="#cb26-40" tabindex="-1"></a><span class="co">#&gt; unit.7                           ml</span></span>
<span id="cb26-41"><a href="#cb26-41" tabindex="-1"></a><span class="co">#&gt; unit.8                            g</span></span>
<span id="cb26-42"><a href="#cb26-42" tabindex="-1"></a><span class="co">#&gt; unit.9                            g</span></span>
<span id="cb26-43"><a href="#cb26-43" tabindex="-1"></a><span class="co">#&gt; unit.10                    teaspoon</span></span></code></pre></div>
</div>
<div id="capturing-raw-input" class="section level3">
<h3>Capturing raw input</h3>
<p>One thing that I’d do next time would also be to include the raw
ingredient names in the output. This doesn’t make much difference in
this simple example but it makes it much easier to align the input with
the output and to start developing automated measures of how well my
prompt is doing.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>instruct_weight_input <span class="ot">&lt;-</span> r<span class="st">&quot;(</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="st">  * If an ingredient has both weight and volume, extract only the weight:</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="st">    ¾ cup (150g) dark brown sugar</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="st">    [</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="st">      {&quot;</span>name<span class="st">&quot;: &quot;</span>dark brown sugar<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 150, &quot;</span>unit<span class="st">&quot;: &quot;</span>g<span class="st">&quot;, &quot;</span>input<span class="st">&quot;: &quot;</span>¾ <span class="fu">cup</span> (<span class="dv">150</span>g) dark brown sugar<span class="st">&quot;}</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="st">    ]</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="st">  * If an ingredient only lists a volume, extract that.</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a><span class="st">    2 t ground cinnamon</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a><span class="st">    ⅓ cup (80ml) neutral oil</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a><span class="st">    [</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a><span class="st">      {&quot;</span>name<span class="st">&quot;: &quot;</span>ground cinnamon<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 2, &quot;</span>unit<span class="st">&quot;: &quot;</span>teaspoon<span class="st">&quot;, &quot;</span>input<span class="st">&quot;: &quot;</span><span class="dv">2</span> t ground cinnamon<span class="st">&quot;},</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a><span class="st">      {&quot;</span>name<span class="st">&quot;: &quot;</span>neutral oil<span class="st">&quot;, &quot;</span>quantity<span class="st">&quot;: 80, &quot;</span>unit<span class="st">&quot;: &quot;</span>ml<span class="st">&quot;, &quot;</span>input<span class="st">&quot;: &quot;</span>⅓ <span class="fu">cup</span> (<span class="dv">80</span>ml) neutral oil<span class="st">&quot;}</span></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a><span class="st">    ]</span></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a><span class="st">)&quot;</span></span></code></pre></div>
<p>I think this is particularly important if you’re working with even
less structured text. For example, imagine you had this text:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>recipe <span class="ot">&lt;-</span> r<span class="st">&quot;(</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="st">  In a large bowl, cream together one cup of softened unsalted butter and a</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="st">  quarter cup of white sugar until smooth. Beat in an egg and 1 teaspoon of</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="st">  vanilla extract. Gradually stir in 2 cups of all-purpose flour until the</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="st">  dough forms. Finally, fold in 1 cup of semisweet chocolate chips. Drop</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="st">  spoonfuls of dough onto an ungreased baking sheet and bake at 350°F (175°C)</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="st">  for 10-12 minutes, or until the edges are lightly browned. Let the cookies</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="st">  cool on the baking sheet for a few minutes before transferring to a wire</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="st">  rack to cool completely. Enjoy!</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a><span class="st">)&quot;</span></span></code></pre></div>
<p>Including the input text in the output makes it easier to see if it’s
doing a good job:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openai</span>(<span class="fu">c</span>(instruct_json, instruct_weight_input))</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="co">#&gt; Using model = &quot;gpt-4o&quot;.</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(recipe)</span></code></pre></div>
<pre><code>#&gt; ```json
#&gt; [
#&gt;   {&quot;name&quot;: &quot;unsalted butter&quot;, &quot;quantity&quot;: 1, &quot;unit&quot;: &quot;cup&quot;, &quot;input&quot;: &quot;one cup 
#&gt; of softened unsalted butter&quot;},
#&gt;   {&quot;name&quot;: &quot;white sugar&quot;, &quot;quantity&quot;: 0.25, &quot;unit&quot;: &quot;cup&quot;, &quot;input&quot;: &quot;a quarter 
#&gt; cup of white sugar&quot;},
#&gt;   {&quot;name&quot;: &quot;egg&quot;, &quot;quantity&quot;: 1, &quot;unit&quot;: &quot;piece&quot;, &quot;input&quot;: &quot;an egg&quot;},
#&gt;   {&quot;name&quot;: &quot;vanilla extract&quot;, &quot;quantity&quot;: 1, &quot;unit&quot;: &quot;teaspoon&quot;, &quot;input&quot;: &quot;1 
#&gt; teaspoon of vanilla extract&quot;},
#&gt;   {&quot;name&quot;: &quot;all-purpose flour&quot;, &quot;quantity&quot;: 2, &quot;unit&quot;: &quot;cup&quot;, &quot;input&quot;: &quot;2 cups 
#&gt; of all-purpose flour&quot;},
#&gt;   {&quot;name&quot;: &quot;semisweet chocolate chips&quot;, &quot;quantity&quot;: 1, &quot;unit&quot;: &quot;cup&quot;, &quot;input&quot;: 
#&gt; &quot;1 cup of semisweet chocolate chips&quot;}
#&gt; ]
#&gt; ```</code></pre>
<p>When I ran it while writing this vignette, it seemed to be working
out the weight of the ingredients specified in volume, even though the
prompt specifically asks it not to. This may suggest I need to broaden
my examples.</p>
</div>
</div>
<div id="token-usage" class="section level2">
<h2>Token usage</h2>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">input</th>
<th align="right">output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">OpenAI-api.openai.com/v1</td>
<td align="right">1149</td>
<td align="right">912</td>
</tr>
<tr class="even">
<td align="left">Claude</td>
<td align="right">788</td>
<td align="right">1201</td>
</tr>
</tbody>
</table>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
